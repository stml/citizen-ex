<div id="cex_hud">

	<div id="cex_header">
		<h1>Citizen Ex</h1>
		<a href="#" class="more" name="more">More Info</a>
		<a href="#" class="close" name="close">Close</a>
		<script type="text/javascript">
			$('#cex_header h1').css("height","24px");
			$('#cex_header h1').css("width","107px");	
			$('#cex_header h1').css("text-indent","-999999px");
			$('#cex_header h1').css("background","url('"+chrome.extension.getURL('images/logo-small-white.svg')+"') no-repeat");
			$('#cex_header a.close').css("height","24px");
			$('#cex_header a.close').css("width","24px");	
			$('#cex_header a.close').css("text-indent","-999999px");
			$('#cex_header a.close').css("background","url('"+chrome.extension.getURL('images/close.png')+"') no-repeat");
		</script>
	</div>

	<div id="cex_main">

	<% if (entry) { %>
	
	  	<div id="cex_badge">
	  	
	  		<div id="cex_badge_column">
	  
				<% if (citizenship.length > 0) { %>
				
				<h2>This is your Algorithmic Citizenship</h2>
				
				<canvas id="cex_badge_canvas"></canvas>
			
			</div><!-- cex_badge_column -->
			
			<div id="cex_data_column">
				
				<table>
					<tr>
						<td class="thead country">Your distribution</td>
						<td class="thead percentage">%</td>
					</tr>
				<% _.each(citizenship, function(country) { %>
					<tr>
						<td class="country"><%= country.code %></td>
						<td class="percentage"><%= country.percentage %></td>
					</tr>
				<% }); %>
				</table>
				
			</div><!-- cex_data_column -->

			<script type="text/javascript">
				var percents = [
				<% _.each(citizenship, function(country) { %>
				  ["<%= country.code %>",<%= country.percentage %>],
				  <% }); %>];
					// set canvas to css heights
				$('#cex_badge_canvas').attr('width', parseInt($('#cex_badge_canvas').css('width')));
				$('#cex_badge_canvas').attr('height', parseInt($('#cex_badge_canvas').css('height')));
				
				var badge = $("#cex_badge_canvas").get(0).getContext("2d");	
				
				// circle centre and radius
				var x0 = $('#cex_badge_canvas').attr('width')/2;
				var y0 = $('#cex_badge_canvas').attr('height')/2;
				var r = Math.min($('#cex_badge_canvas').attr('height')/2,$('#cex_badge_canvas').attr('width')/2);
			
				var circlepointer = 0;
				
				$.each(percents, function() {
					var country = this[0];
					var value = this[1];
					var degrees = 360*(value/100);
					drawSegment(badge,x0,y0,r,circlepointer,country,degrees);
					circlepointer = circlepointer + degrees;
					});
					
				function drawSegment(badge,x0,y0,r,circlepointer,country,degrees) {
					var img = new Image();
					img.onload = function() {
						var flagscaledheight = badge.canvas.clientHeight;
						var flagscaledwidth = flagscaledheight*(img.width/img.height);
						var flagmargin = (flagscaledwidth - badge.canvas.clientWidth) / 2;
						var svgCanvas = document.createElement("canvas");
				    	svgCanvas.height = flagscaledheight;
				    	svgCanvas.width = flagscaledwidth;
				    	var svgCtx = svgCanvas.getContext("2d");
				    	svgCtx.drawImage(img, -flagmargin, 0, flagscaledwidth, flagscaledheight);
				    	var pattern = badge.createPattern(svgCanvas, 'repeat');
				    	badge.fillStyle = pattern;
						badge.beginPath();
						badge.moveTo(x0, y0);
						var xy = circleCoords(x0,y0,r,circlepointer);
						badge.lineTo(xy[0],xy[1]);
						for (i = 0; i < degrees; i=i+30) {
							xy = circleCoords(x0,y0,r,circlepointer+i);
							badge.lineTo(xy[0],xy[1]);
							}
						xy = circleCoords(x0,y0,r,circlepointer+degrees);
						badge.lineTo(xy[0],xy[1]);
						badge.closePath();
						badge.lineWidth=1;
						badge.strokeStyle="#333";
						badge.stroke();
						badge.fill();
				      	};	
				    img.src = chrome.extension.getURL('flags/'+country+'.svg');
					}	
					
				function circleCoords(x0,y0,r,theta) {
					var x = x0 + r * Math.cos(theta * Math.PI / 180);
					var y = y0 + r * Math.sin(theta * Math.PI / 180);
					return [x,y];	
					}
					
			</script>  
				
		</div><!-- cex_badge -->
								  
				<% } else { %>
				  <h2>No Citizenship data available yet. Keep browsing!</h2>
				<% }; %>
		
		<div id="cex_map">
		
		<div id="cex_map_window" class="dark"><img id="cex_map_loading" src="" alt="Loading"/></div>
	    
	  	<script type="text/javascript">
	  	$('img#cex_map_loading').attr('src',chrome.extension.getURL('images/loading.gif'));
	  	setTimeout(function(){ cex_drawMap(); }, 1000);
	  	function cex_drawMap() {
			var cexmap = L.map('cex_map_window');
			L.tileLayer('https://{s}.tiles.mapbox.com/v3/stml.l6086pbg/{z}/{x}/{y}.png', {
				attribution: '<a href="http://mapbox.com/about/maps">&copy; Mapbox &copy; OpenStreetMap</a>'}).addTo(cexmap);
			cexmap.attributionControl.setPrefix("");
			L.Icon.Default.imagePath = chrome.extension.getURL('leaflet-images');
			cexmap.setView([0,0],2);
			var cexmarkergroup = new L.featureGroup();
			<% if (ownGeoData && ownGeoData.ownIp) { %>
				var origMarker = L.marker([<%= ownGeoData.ownLat %>, <%= ownGeoData.ownLng %>]).addTo(cexmap);
				cexmarkergroup.addLayer(origMarker);
			<% } else { %>
		    <% }; %>
			<% if (entry.ip) { %>
				var destMarker = L.marker([<%= entry.lat %>, <%= entry.lng %>]).addTo(cexmap);
				cexmarkergroup.addLayer(destMarker);
		    <% } else { %>
		    
		    <% }; %>
		    cexmap.fitBounds(cexmarkergroup.getBounds(), {padding: [50,50]});
		    // kill loading circle
		    $('img#cex_map_loading').hide();
		    }
	    
	  	</script>
	    
	    		<div id="cex_mapdata">
	    		
	    			<div id="cex_dest_column">
	    				<h3>Current remote location</h3>
					    <% if (ownGeoData && ownGeoData.ownIp) { %>
					      <p><strong><% if (entry.city.length > 0) { %><%= entry.city %>, <% } %><%= entry.countryCode %></strong></p>
					      <p>IP Address: <%= entry.ip %></p>
					      <p>Lat: <%= entry.lat %> / Lon: <%= entry.lng %></p>
					    <% } else { %>   
					      <p><strong>Remote location is unknown</strong></p>
					      <p></p>
					      <p></p>
					    <% }; %>
				    </div><!-- cex_dest_column -->
				    <div id="cex_orig_column">
	    				<h3>Your tracked location</h3>
					    <% if (entry.ip) { %>
					      <p><strong><% if (ownGeoData.ownCity.length > 0) { %><%= ownGeoData.ownCity %>, <% } %><%= ownGeoData.ownCountryCode %></p>
					      <p>IP Address: <%= ownGeoData.ownIp %></p>
					      <p>Lat: <%= ownGeoData.ownLat %> / Lon: <%= ownGeoData.ownLng %></p>
					    <% } else { %>   
					      <p><strong>Your location is unknown</strong></p>
					      <p></p>
					      <p></p>
					    <% }; %>
				    </div><!-- cex_orig_column -->
				</div><!-- cex_mapdata -->
	    
	    </div><!-- cex_map -->
	    
	  <% } else { %>
	  
	  		<div id="cex_nodata">
				<p>No data available yet.</p>
			</div>
	  <% }; %>
	  
	</div><!-- #cex_main -->

</div><!-- #cex_hud -->